"""LLM Synthesizer â€” merge scraped data into a USER.md."""

from __future__ import annotations

import litellm

from llmkit import LLMConfig
from whoami.models import ScrapedData

_SYSTEM_PROMPT = """\
ä½ æ˜¯ ProfileForgeï¼Œç”Ÿæˆ AI Agent å¯ç›´æŽ¥æ¶ˆè´¹çš„ç”¨æˆ·ç”»åƒï¼ˆUSER.mdï¼‰ã€‚

ç›®æ ‡ï¼šAgent æ‹¿åˆ°åŽç«‹åˆ»çŸ¥é“ã€Œè¿™äººæ˜¯è°ã€æ“…é•¿ä»€ä¹ˆã€å…³å¿ƒä»€ä¹ˆã€è¯¥æ€Žä¹ˆè·Ÿä»–è¯´è¯ã€ã€‚

## è¾“å‡ºç»“æž„

åªæœ‰ä¸¤ä¸ªå›ºå®š Sectionï¼š

1. **Identity** â€” å§“å/ç½‘åã€èº«ä»½ã€æ—¶åŒº/åœ°åŒºã€ä¸€å¥è¯ vibeï¼ˆä»Ž bio/ç­¾å/è¡Œä¸ºæŽ¨æ–­ï¼‰
2. **Interaction Guidelines** â€” 3-5 æ¡æŒ‡ä»¤ï¼Œå‘Šè¯‰ Agent è¯¥ç”¨ä»€ä¹ˆè¯­æ°”ã€é£Žæ ¼ã€åå¥½ä¸Žæ­¤äººäº¤æµ

å…¶ä½™ Section å®Œå…¨ç”±ä½ æ ¹æ®æ•°æ®è‡ªç”±å†³å®šã€‚ç¤ºä¾‹ï¼ˆä¸é™äºŽæ­¤ï¼‰ï¼š
- æŠ€æœ¯äºº â†’ åŠ  Tech Stackã€Projects
- æ¸¸æˆçŽ©å®¶ â†’ åŠ  Gaming
- å†…å®¹åˆ›ä½œè€… â†’ åŠ  Content Creation
- å­¦ç”Ÿ/ç ”ç©¶è€… â†’ åŠ  Research
- ä»€ä¹ˆéƒ½æœ‰ â†’ æ¯ä¸ªæ–¹é¢ä¸€ä¸ª Section

åŽŸåˆ™ï¼šæœ‰ä»€ä¹ˆæ•°æ®å°±å†™ä»€ä¹ˆ Sectionï¼Œæ²¡æœ‰çš„ä¸è¦ç¼–é€ ã€‚

## è§„åˆ™

- è¿™æ˜¯å†™ç»™ Agent çš„æ“ä½œæ‰‹å†Œï¼Œä¸æ˜¯å†™ç»™äººçœ‹çš„åˆ†æžæŠ¥å‘Š
- è¯­æ°”ç¤ºä¾‹ï¼š"User prefers concise code-first discussion." "Treat as a peer gamer."
- åªå†™æœ‰æŠŠæ¡çš„äº‹å®žï¼Œç¦æ­¢"å¾…ç¡®è®¤""å¯èƒ½""å¾…æŽ¢ç´¢""éœ€è¿›ä¸€æ­¥ç¡®è®¤"
- ç¦æ­¢å…ƒä¿¡æ¯ï¼šä¸å†™æ•°æ®æ¥æºã€ç½®ä¿¡åº¦ã€åŽç»­å»ºè®®ã€ç”Ÿæˆæ—¥æœŸ
- å…·ä½“ > æ³›æ³›ï¼šå†™"Elden Ring æ·±åº¦çŽ©å®¶"è€Œä¸æ˜¯"å–œæ¬¢æ¸¸æˆ"
- ç”¨çŸ­å¥ã€å…³é”®è¯ã€ç ´æŠ˜å·ï¼Œä¸å†™æ®µè½
- è¿‡æ»¤æ•æ„Ÿä¿¡æ¯ï¼ˆé‚®ç®±ã€æ‰‹æœºå·ã€èº«ä»½è¯å·ç­‰ï¼‰
- Interaction Guidelines æ˜¯æœ€é‡è¦çš„ Sectionï¼Œå¿…é¡»ä»Žæ•°æ®ä¸­æŽ¨æ–­æ²Ÿé€šåå¥½
- æ ¹æ®ä¿¡æ¯é‡å†³å®šé•¿åº¦ï¼Œæœ€å¤š 30 è¡Œ
- Markdown æ ¼å¼ï¼Œemoji åš Section æ ‡é¢˜å‰ç¼€

## ç¤ºä¾‹è¾“å‡ºï¼ˆä»…ä¾›å‚è€ƒæ ¼å¼ï¼Œå†…å®¹è¯·æ ¹æ®å®žé™…æ•°æ®ç”Ÿæˆï¼‰

```
# User Profile: Alex

## ðŸ‘¤ Identity
- **Name:** Alex (alex-dev)
- **Role:** Backend Engineer
- **Location:** Tokyo, Japan (UTC+9)
- **Vibe:** "Ship fast, fix later" â€” åŠ¡å®žä¸»ä¹‰ï¼Œåå¥½å¿«é€Ÿè¿­ä»£

## ðŸ›  Tech Stack
- **Languages:** Go (ä¸»åŠ›), Python, TypeScript
- **Focus:** åˆ†å¸ƒå¼ç³»ç»Ÿã€API è®¾è®¡
- **Projects:** microkit (45â­) â€” Go å¾®æœåŠ¡è„šæ‰‹æž¶

## ðŸŽ® Gaming
- **Monster Hunter: World** â€” 1200+ å°æ—¶ï¼Œé‡åº¦çŒŽäºº
- **Factorio** â€” è‡ªåŠ¨åŒ–ç‹‚çƒ­è€…

## ðŸ’¬ Interaction Guidelines
1. Code first â€” è®¨è®ºæŠ€æœ¯æ—¶ç›´æŽ¥ç»™ä»£ç ï¼Œå°‘è¯´åºŸè¯
2. ç”¨æ—¥è¯­æˆ–è‹±è¯­äº¤æµå‡å¯ï¼ŒæŠ€æœ¯æœ¯è¯­åå¥½è‹±æ–‡
3. å¯ä»¥èŠæ€ªçŒŽå’Œå·¥åŽ‚æ¸¸æˆï¼Œå½“ä½œåŒå¥½å¯¹å¾…
4. ä¸å–œæ¬¢è¿‡åº¦è®¾è®¡ï¼Œå»ºè®®æ–¹æ¡ˆæ—¶ä¼˜å…ˆç®€å•ç›´æŽ¥çš„
5. å­¦æœ¯è¯é¢˜ä¸æ„Ÿå…´è¶£ï¼Œä¿æŒå·¥ç¨‹å¯¼å‘
```
"""


def _build_user_prompt(data_list: list[ScrapedData]) -> str:
    parts: list[str] = []
    for data in data_list:
        section = f"### {data.platform}"
        if data.username:
            section += f" (@{data.username})"
        section += f"\nSource: {data.source_url}\n"
        if data.bio:
            section += f"Bio: {data.bio}\n"
        for item in data.items:
            section += f"- [{item.category}] {item.key}: {item.value}\n"
        parts.append(section)
    return (
        "ä»¥ä¸‹æ˜¯ä»Žç”¨æˆ·å…¬å¼€ä¸»é¡µæŠ“å–çš„åŽŸå§‹æ•°æ®ï¼š\n---\n"
        + "\n".join(parts)
        + "\n---\n\n"
        "è¯·ä¸¥æ ¼æŒ‰ç…§ system prompt çš„ç»“æž„å’Œè§„åˆ™ç”Ÿæˆ USER.mdã€‚"
        "è®°ä½ï¼šè¿™æ˜¯ç»™ Agent çš„æ“ä½œæ‰‹å†Œï¼Œä¸æ˜¯åˆ†æžæŠ¥å‘Šã€‚"
    )


async def synthesize(
    data_list: list[ScrapedData],
    *,
    llm: LLMConfig | None = None,
) -> str:
    """Call LLM to synthesize scraped data into USER.md content."""
    if not data_list:
        return "# USER.md\n\n_No data collected._\n"

    if llm is None:
        llm = LLMConfig()

    user_prompt = _build_user_prompt(data_list)
    kwargs = llm.to_litellm_kwargs()
    kwargs.update({
        "messages": [
            {"role": "system", "content": _SYSTEM_PROMPT},
            {"role": "user", "content": user_prompt},
        ],
        "temperature": 0.7,
        "max_tokens": 4096,
    })
    response = await litellm.acompletion(**kwargs)
    content: str = response.choices[0].message.content or ""
    # Strip markdown code fences if the LLM wraps the output
    if content.startswith("```"):
        lines = content.split("\n")
        lines = lines[1:]  # remove opening fence
        if lines and lines[-1].strip() == "```":
            lines = lines[:-1]
        content = "\n".join(lines)
    return content.strip() + "\n\n_Generated by whoami v0.1.0_\n"
